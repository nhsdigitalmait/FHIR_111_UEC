# Simulator rule definition file for ITK Testbench
#  FHIR 111 UEC Booking
#	Richard Robinson 14/10/2020
#
BEGIN RESPONSES

#NEW
#Search
notFound_Response						TKW_ROOT/config/FHIR_111_UEC/simulator_config/successful_responses/NotFound_Trigger_NEMS.xml "200 OK"
Conversion_Error_Response					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_200_IVP.xml "400 Bad Request"
HTTP_From_MISSING_Response					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_400_MOIH_From.xml "400 Missing Or Invalid Header"
HTTP_To_MISSING_Response					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_400_MOIH_To.xml "400 Missing Or Invalid Header"
HTTP_Authorization_MISSING_Response			TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_400_MOIH_Auth.xml "400 Missing Or Invalid Header"

#PreExistingServerResponses
operation_outcome_all_other_requests					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_all_other_requests.xml 404
operation_outcome_unsupported_verb_404					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_unsupported_verb.xml 404
Operation_Outcome_400					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_400_IP.xml "400 Bad Request"
Operation_Outcome_403					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_403_AD.xml "403 Forbidden"
Operation_Outcome_404					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_404_NRF.xml "404 Not Found"
Operation_Outcome_405					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_405_NS.xml "405 Method Not Allowed"
Operation_Outcome_409					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_409.xml "409 Conflict" WITH_HTTP_HEADERS (  Date : "__RFC822TIMESTAMP__" )
Operation_Outcome_412 					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_412.xml	"412 Precondition Failed" WITH_HTTP_HEADERS (  Date : "__RFC822TIMESTAMP__" )
Operation_Outcome_415					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_415_UMT.xml "415 Unsupported Media Type"
Operation_Outcome_422_IP					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_422_IP.xml "422 Unprocessable Entity"
Operation_Outcome_422_IR					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_422_IR.xml "422 Unprocessable Entity"
Operation_Outcome_422_RNF					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_422_RNF.xml "422 Unprocessable Entity"
Operation_Outcome_500					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_500_ISE.xml "500 Internal Server Error"
Operation_Outcome_502					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_502_BG.xml "502 Bad Gateway"
Operation_Outcome_504					TKW_ROOT/config/FHIR_111_UEC/simulator_config/operation_outcomes/operation_outcome_504_GT.xml "504 Gateway Timeout"
#NHS 111 UEC Booking

SearchSlots_HappyPath_Response	TKW_ROOT/config/FHIR_111_UEC/simulator_config/111_UEC_Booking/SearchSlots_HappyPath_Response.xml 200 
SearchSlots_HappyPath_NoSlots_Response	TKW_ROOT/config/FHIR_111_UEC/simulator_config/111_UEC_Booking/SearchSlots_HappyPath_NoSlots_Response.xml 200 

BookAppointment_HappyPath_Response	class:uk.nhs.digital.mait.tkwx.tk.internalservices.rules.routingactor.ackextension.SendEmptyResponse "201 Created" WITH_HTTP_HEADERS ( Location : "https://clinicals.spineservices.nhs.uk/STU3/Appointment/__MESSAGEID__/_history/__VERSIONID__" Date : "__RFC822TIMESTAMP__" ETag : "W/\"__VERSIONID__\"" Last-Modified : "__TIMESTAMP__" )
CancelAppointment_HappyPath_Response	TKW_ROOT/config/FHIR_111_UEC/simulator_config/111_UEC_Booking/CancelAppointment_HappyPath_Response.xml "200 OK" WITH_HTTP_HEADERS ( Location : "https://clinicals.spineservices.nhs.uk/STU3/Appointment/__MESSAGEID__/_history/__VERSIONID__" Date : "__RFC822TIMESTAMP__" ETag : "W/\"__VERSIONID__\"" Last-Modified : "__TIMESTAMP__" )

do_process	NONE	0
END RESPONSES

BEGIN SUBSTITUTIONS
__MESSAGEID__	uuid
__VERSIONID__	uuid
__TIMESTAMP__	ISO8601datetime
__TOMORROW__ Class uk.nhs.digital.mait.tkwx.tk.internalservices.rules.FormattedTimeSubstitution "yyyy-MM-dd Europe/London 1 0"
__DAY_AFTER_TOMORROW__ Class uk.nhs.digital.mait.tkwx.tk.internalservices.rules.FormattedTimeSubstitution "yyyy-MM-dd Europe/London 2 0"
__CANCEL_SLOT_START_TIME__	Xpath /fhir:Appointment/fhir:contained/fhir:Slot/fhir:start/@value
__CANCEL_SLOT_END_TIME__	Xpath /fhir:Appointment/fhir:contained/fhir:Slot/fhir:end/@value
__CANCEL_START_TIME__	Xpath /fhir:Appointment/fhir:start/@value
__CANCEL_END_TIME__	Xpath /fhir:Appointment/fhir:end/@value
__CANCEL_CREATED_TIME__	Xpath /fhir:Appointment/fhir:created/@value
__FULL_CONTEXT_PATH__ reg_exp context_path "." "$0"
__HOST__ reg_exp http_header Host "." "$0"


END SUBSTITUTIONS

# all the "match/contains" rules apply to the content by default to use eg the context path it must be specified as context_path
BEGIN EXPRESSIONS

Ssp_From_MISSING				http_header Ssp-from notmatches ^.+$
HEALTHCARESERVICE_MISSING		context_path notcontains schedule.actor:healthcareservice
SLOT_MISSING					xpathnotmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value ^.+$
HTTP_Authorization_MISSING		http_header Authorization notmatches ^.+$

#PreExistingServer expresions
EMPTY_CONTENT					matches ^$
# must be before parameters check since coversion from json wont happen IF content-type is wrong
INVALID_CONTENT_TYPE			http_header content-type matches ^.*(text.*|application\/[a-z]+[^+]*)$
#
#http header checks
#
EMPTY_ACCEPT					http_header accept notmatches ^.+$
INVALID_ACCEPT					http_header accept notmatches ^.*application\/fhir\+(xml|json).*$
#

#NHS 111 UEC Booking

#CONTEXT PATH CHECKS
SLOT						context_path matches ^.*\/STU3\/Slot.*$
HEALTHCARESERVICE999999999999		context_path matches ^.*schedule.actor:healthcareservice=999999999999.*$
HEALTHCARESERVICE999999999998		context_path matches ^.*schedule.actor:healthcareservice=999999999998.*$
HEALTHCARESERVICE999999999997		context_path matches ^.*schedule.actor:healthcareservice=999999999997.*$
HEALTHCARESERVICE999999999996		context_path matches ^.*schedule.actor:healthcareservice=999999999996.*$
HEALTHCARESERVICE999999999995		context_path matches ^.*schedule.actor:healthcareservice=999999999995.*$
HEALTHCARESERVICE999999999994		context_path matches ^.*schedule.actor:healthcareservice=999999999994.*$

APPOINTMENT							context_path matches ^.*\/STU3\/Appointment.*$
SLOT005								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot005
SLOT006								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot006
SLOT007								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot007
SLOT008								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot008
SLOT009								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot009
SLOT010								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot010
SLOT011								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot011
SLOT012								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot012
SLOT013								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot013
SLOT014								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot014
SLOT015								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot015
SLOT016								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot016
SLOT017								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot017
SLOT018								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot018
SLOT019								xpathmatches /fhir:Appointment/fhir:contained/fhir:Slot/fhir:id/@value slot019

#HTTP HEADER CHECKS
#QUESTION - is the GUID Upper or Lower case? 3cb63c23-2d28-49c5-ad57-033fcbba71c7
#TRACEID033fcbba71c7			http_header Ssp-TraceID matches ^.*3[cC][bB]63[cC]23-2[dD]28-49[cC]5-[aA][dD]57-033[fF][cC][bB][bB][aA]71[cC]7.*$

passthrough	Always
dontpassthrough	Never
#
END EXPRESSIONS

BEGIN RULE
POST
IF 	Ssp_From_MISSING		THEN	Operation_Outcome_400				ELSE	NEXT
IF 	SLOT_MISSING			THEN	Operation_Outcome_400				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT005	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT006	THEN	Operation_Outcome_422_IP			ELSE	NEXT
IF	APPOINTMENT	AND	SLOT007	THEN	Operation_Outcome_422_IR			ELSE	NEXT
IF	APPOINTMENT	AND	SLOT008	THEN	Operation_Outcome_400				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT009	THEN	Operation_Outcome_403				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT009	THEN	Operation_Outcome_405				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT010	THEN	Operation_Outcome_500				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT011	THEN	Operation_Outcome_415				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT012	THEN	Operation_Outcome_502				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT013	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT014	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT015	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT016	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT017	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT018	THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT019 THEN	BookAppointment_HappyPath_Response	ELSE	NEXT
IF passthrough THEN notFound_Response
END RULE

#=========================================================================================
# Http methods no interactionid

BEGIN RULE
GET
IF 	Ssp_From_MISSING							THEN	Operation_Outcome_400					ELSE	NEXT
IF 	HEALTHCARESERVICE_MISSING					THEN	Operation_Outcome_400					ELSE	NEXT
IF	SLOT	AND	HEALTHCARESERVICE999999999999	THEN	SearchSlots_HappyPath_Response			ELSE	NEXT
IF	SLOT	AND	HEALTHCARESERVICE999999999998	THEN	SearchSlots_HappyPath_NoSlots_Response	ELSE	NEXT
IF	SLOT	AND	HEALTHCARESERVICE999999999997	THEN	Operation_Outcome_400					ELSE	NEXT
IF	SLOT	AND	HEALTHCARESERVICE999999999996	THEN	Operation_Outcome_403					ELSE	NEXT
IF	SLOT	AND	HEALTHCARESERVICE999999999995	THEN	Operation_Outcome_500					ELSE	NEXT
IF	SLOT	AND	HEALTHCARESERVICE999999999994	THEN	Operation_Outcome_405					ELSE	NEXT
IF passthrough THEN notFound_Response
END RULE

BEGIN RULE
PUT
IF 	Ssp_From_MISSING		THEN	Operation_Outcome_400					ELSE	NEXT
IF 	SLOT_MISSING			THEN	Operation_Outcome_400					ELSE	NEXT
IF	APPOINTMENT	AND	SLOT005 THEN	CancelAppointment_HappyPath_Response	ELSE	NEXT
IF	APPOINTMENT	AND	SLOT013 THEN	Operation_Outcome_422_RNF				ELSE	NEXT
IF	APPOINTMENT	AND	SLOT014 THEN	Operation_Outcome_409					ELSE	NEXT
IF	APPOINTMENT	AND	SLOT015 THEN	Operation_Outcome_412					ELSE	NEXT
IF	APPOINTMENT	AND	SLOT016 THEN	Operation_Outcome_400					ELSE	NEXT
IF	APPOINTMENT	AND	SLOT017 THEN	Operation_Outcome_403					ELSE	NEXT
IF	APPOINTMENT	AND	SLOT018 THEN	Operation_Outcome_500					ELSE	NEXT
IF	APPOINTMENT	AND	SLOT019 THEN	Operation_Outcome_504					ELSE	NEXT
IF passthrough THEN operation_outcome_unsupported_verb_404
END RULE

BEGIN RULE
DELETE
IF passthrough THEN notFound_Response
END RULE

BEGIN RULE
PATCH
IF passthrough THEN operation_outcome_unsupported_verb_404
END RULE

BEGIN RULE
OPTIONS
IF passthrough THEN operation_outcome_unsupported_verb_404
END RULE
#=========================================================================================
